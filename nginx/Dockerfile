FROM nginx:alpine

# Pulls domain from docker-compose.yml
ARG domain
ARG certs=/certs/temp

COPY certbot.sh /bin

RUN echo "ğŸ“¥ Installing dependencies ğŸ“¥" \
	&& apk update && apk upgrade \
	&& apk add --no-cache --no-progress \
	bash \
	openssl \
	git \
	certbot \
	&& echo "ğŸ“ Creating certs and certbot webroot folders ğŸ“" \
	&& mkdir -p /var/lib/certbot \
	&& mkdir -p $certs \
	&& echo "ğŸ” Generating temporary self-signed certificate ğŸ”" \
	&& openssl req -x509 -nodes -newkey rsa:4096 \
	-keyout "$certs/privkey.pem" \
	-out "$certs/fullchain.pem" \
	-subj "/C=/ST=/L=/O=/CN=$domain" \
	&& echo "ğŸ” Creating symlink for latest certs ğŸ”" \
	&& ln -sf $certs /certs/latest

