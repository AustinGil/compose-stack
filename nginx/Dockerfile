FROM nginx:alpine

# Pulls domains from docker-compose.yml
ARG certs_dir=/certs/temp

COPY certbot.sh /bin

RUN echo "ğŸ“¥ Installing dependencies ğŸ“¥" \
	&& apk update && apk upgrade \
	&& apk add --no-cache --no-progress \
	bash \
	openssl \
	git \
	certbot \
	&& echo "ğŸ“ Creating certs and certbot webroot folders ğŸ“" \
	&& mkdir -p /var/lib/certbot \
	&& mkdir -p $certs_dir \
	&& echo "ğŸ” Generating temporary self-signed certificate ğŸ”" \
	&& openssl req -x509 -nodes -newkey rsa:4096 \
	-keyout "$certs_dir/privkey.pem" \
	-out "$certs_dir/fullchain.pem" \
	-subj "/C=/ST=/L=/O=/CN=arbitrary.com" \
	&& echo "ğŸ” Creating symlink for latest certs ğŸ”" \
	&& ln -sf $certs_dir /certs/latest

